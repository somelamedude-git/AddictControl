const { Family } = require('../models/Users.model.js');
const { Addict } = require('../models/Users.model.js');
const { can_be_taken } = require('../utils/requests.util.js');
const axios = require('axios');
require('dotenv').config({path: '../.env'});

const request_phone_call = async(req, res)=>{
	const user_id = req.user._id;
	try{
		const family_member = await Family.findById(user_id.toString(), "addict_member_email").lean();
		const addict_email = family_member.addict_member_email;
		const alcoholic = await Addict.findOne({email:addict_email});

		if(!alcoholic){
			return res.status(404).json({
				success: false,
				message: "Requested user not found"
			});
		}

		const response = await axios.post('link_to_api(add later)', {addict_email}); // add headers later
		console.log(response.data);
		return res.status(200).json({
			success:true,
			message: "Request for call sent"
		});
	}
	catch(err){
		console.log(err);
		return res.status(500).json({
			success: false,
			message: "Internal server error"
		});
	}
}

const addict_portal_call = async(req, res)=>{
	const {addict_email} = req.body;
	try{
		const addict = await Addict.findOne({email:addict_email}); // already verified

		const socket_id = socket_array[addict._id.toString()];
		io.to(socket_id).emit("incoming_call", {
			audio: ""
		});
		res.json({
			message: "called"
		});
	}
	catch(error){
		console.log('screw me');
	}
} // to be connected with frontend through socket.on

const accept_call = async(req, res)=>{ // call test generation api here
		try{
		const user_id = req.user.id;
		const user = await Addict.findById(user_id);
		if(!user) return res.status(404).json({success: false, message: "User not found"});
		
		const response = await axios.post('/test/request', {user_id:user_id}); // now the test will go to the database with this request

	        return res.status(200).json({
			                audio: process.env.AUDIO_LINK
			        });
		}
		catch(err){
			// handle error here
		}
}


module.exports = {
	request_phone_call,
	addict_portal_call,
	accept_call
}
